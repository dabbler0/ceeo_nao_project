<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>
      $(function () {
        var buttons = [],
        	root_button = $("div#root"),
        	log = $("div#log"),
        	button_list = $("div#button_list")

        function interpret(commands) {
          var lines = commands.split("\n"),
            rarray = [];
          for (var i = 0; i < lines.length; i += 1) {
            var index, key, srarray = [];
            srarray.push("command=" + encodeURIComponent(lines[i].slice(0, index = lines[i].indexOf(" "))));
            if (index === -1) {
              rarray.push("command=" + encodeURIComponent(lines[i]));
            } else {
              params = lines[i].slice(index + 1).split(", ");
              for (var x = 0; x < params.length; x += 1) {
                key = params[x].slice(0, index = params[x].indexOf(" "));
                value = encodeURIComponent(params[x].slice(index + 1));
                srarray.push(key + "=" + value);
              }
              rarray.push(srarray.join("&"));
            }
          }
          return rarray;
        }
        $('button#clearconsole').click(function () {
        	if (log.children().length != 0) {
        		$('div.shader').show();
        		$('div.confirmation').show();
        		$('button#confirm').click(function() {
        			log.html('');
        			$('div.confirmation').hide();
        			$('div.shader').hide();
        		});
        	}
        });
        $('button#newebutton').click(function () {
          $('div#root').addClass('dialogged');
          setTimeout(function () {
            $('#root_dialog').show();
            $('#new_button_name').select();
          }, 300);
          root_expanded = true;
          $('#new_button_commands').val(editor.getValue());
        });
        $('button#cleareditor').click(function() {
        	if (editor.getValue() != '') {
        		$('div.shader').show();
        		$('div.confirmation').show();
        		$('button#confirm').click(function() {
        			editor.setValue('');
        			$('div.confirmation').hide();
							$('div.shader').hide();
        		});
        	}
				});
				$('button#newebutton').click(function() {
					$('button#cleareditor').hide();
					$('button#newebutton').hide();
					$('button#runbutton').hide();
					$('button#cancelbutton').show()
					$('button#savebutton').show()
					$('span#editortitle').hide();
					$('span#editor_new_name').show();
					$('input#new_ebutton_name').select();
				});
				$('button#savebutton').click(function() {
					var new_button_obj, new_button, nindex = buttons.length;
					buttons.push(new_button_obj = {
						"name": $('input#new_ebutton_name').val(),
						"commands": editor.getValue()
					});
					root_button.after(new_button = $("<div>").addClass("button").attr("title", new_button_obj.commands).append($('<button>').addClass('run').addClass('field').text('R').attr('title', 'Run').click(function () {
						interpretation = interpret(new_button_obj.commands);
						for (var i = 0; i < interpretation.length; i += 1) {
							log_div = $("<div>").addClass("log").text("[" + new_button_obj.name + "] " + new_button_obj.commands.split('\n')[i]);
							log.append(log_div);
							log_div[0].scrollIntoView(false);
							$.ajax({
								url: "/execute?" + interpretation[i], /*error: function(blah, err, log_div) {
									if (err == 'error') log_div.append($('<div>').addClass('indented').text("couldn't connect"));
								}(log_div),*/
								dataType: "json",
								response: (function(log_div) {
									return function(server_response) {
										log_div.append($('<div>').addClass('indented').text(server_response.response));
									}
								}(log_div)),
								success: (function(log_div) {
									return function(server_response) {
										log_div.append($('<div>').addClass('indented').text(server_response.success ? "Success" : "Failure"));
									}
								}(log_div))
							});
						}
					})).append($('<button>').addClass('edit').addClass('field').text('E').attr('title', 'Edit').click(function() {
						if (new_button.children('.button_dialog').css('display') == 'none') {
							new_button.children('.button_dialog').children('div.field_wrapper').eq(0).children('input.field').val(new_button_obj.name);
							new_button.children('.button_dialog').children('div.field_wrapper').eq(1).children('textarea.field').val(new_button_obj.commands);
							if (new_button.children('.button_title').text() == '') new_button.addClass('bdialogged');
							else new_button.addClass('adialogged');
							new_button.children('.edit').text('C').attr('title', 'Cancel');
							new_button.children('.run').hide();
							setTimeout(function() {
								new_button.children('.button_dialog').show();
							}, 301);
						}
						else {
							new_button.removeClass('adialogged');
							new_button.removeClass('bdialogged');
							new_button.children('.edit').text('E').attr('title', 'Edit');
							new_button.children('.run').show();
							new_button.children('.button_dialog').hide();
						}
					})).append($("<button>").addClass('delete').addClass('field').text('D').attr('title', 'Delete').click(function() {
						$('div.shader').show();
						$('div.confirmation').show();
						$('button#confirm').click(function() {
							new_button.remove();
							buttons.splice(nindex, 1);
							$('div.confirmation').hide();
							$('div.shader').hide();
						});
					})).append($('<div>').addClass('button_title').text(new_button_obj.name)).append($('<div>').addClass('init_hidden').addClass('button_dialog').html('<div class="field_wrapper">Name: <input class="field" class="button_new_name"/></div><div class="field_wrapper"><div class="textarea_field_label">Commands:</div><textarea class="field" class="button_new_commands"></textarea></div>').append($('<button>').addClass('field').text('done').click(function() {
						new_button_obj.name = new_button.children('.button_dialog').children('div.field_wrapper').eq(0).children('input.field').val();
						new_button.children('.button_title').text(new_button_obj.name);
						new_button_obj.commands = new_button.children('.button_dialog').children('div.field_wrapper').eq(1).children('textarea.field').val();
						new_button.attr('title', new_button_obj.commands);
						new_button.removeClass('adialogged');
						new_button.removeClass('bdialogged');
						new_button.children('.edit').text('E').attr('title', 'Edit');
						new_button.children('.run').show();
						new_button.children('.button_dialog').hide();
					}))));
					$('input#new_ebutton_name').val('');
					$('span#editor_new_name').hide();
					$('span#editortitle').show();
					$('button#cancelbutton').hide();
					$('button#savebutton').hide();
					$('button#cleareditor').show();
					$('button#newebutton').show();
					$('button#runbutton').show();
				});
				$('button#cancelbutton').click(function() {
					$('input#new_ebutton_name').val('');
					$('span#editor_new_name').hide();
					$('span#editortitle').show();
					$('button#cancelbutton').hide();
					$('button#savebutton').hide();
					$('button#cleareditor').show();
					$('button#newebutton').show();
					$('button#runbutton').show();
				});
				$('button#runbutton').click(function() {
					interpretation = interpret(editor.getValue());
					for (var i = 0; i < interpretation.length; i += 1) {
						log_div = $("<div>").addClass("log").text("[Editor] " + editor.getValue().split('\n')[i]);
						log.append(log_div);
						log_div[0].scrollIntoView(false);
						$.ajax({
							url: "/execute?" + interpretation[i], /*error: function(blah, err, log_div) {
								if (err == 'error') log_div.append($('<div>').addClass('indented').text("couldn't connect"));
							}(log_div),*/
							dataType: "json",
							success: (function(log_div) {
								return function(server_response) {
									log_div.append($('<div>').addClass('indented').text(server_response.response));
									log_div.append($('<div>').addClass('indented').text(server_response.success ? "Success" : "Failure"));
								}
							}(log_div))
						});
					}
				});
				$('button#deny').click(function() {
					$('div.confirmation').hide();
					$('div.shader').hide();
				});
      })
    </script>
    <style>
      body,html
      {
        background:#EEE;
        overflow:hidden;
        font-family:Lato, Verdana, Arial, sans-serif;
        margin:0;
        padding:0;
      }

      div.blockish
      {
        position:absolute;
      }

      div.blockish#left_wrap
      {
        left:0;
        top:0;
        bottom:0;
        width:350px;
        box-shadow:1px 0 1px #888 inset;
      }

      div.blockish#right_wrap
      {
        top:0;
        bottom:0;
        right:0;
        left:350px;
        border-left:1px solid #888;
        overflow:auto;
      }

      div#left_wrap
      {
        background:#FFF;
        overflow:auto;
      }

      div.button
      {
        height:50px;
        line-height:50px;
        cursor:pointer;
        font-size:20px;
        border-bottom:1px solid #888;
        box-shadow:1px 0 1px #888 inset;
        transition:background .3s ease-in, height .3s ease-in, color .3s ease-in;
        color:#000;
        padding:10px;
      }

      div.button:nth-of-type(odd)
      {
        background:#EEE;
      }

      div.button:nth-of-type(even)
      {
        background:#CCC;
      }

      div.button:nth-of-type(odd):hover
      {
        background:#DDD;
      }

      div.button:nth-of-type(even):hover
      {
        background:#BBB;
      }
      .init_hidden {
        display:none;
      }

      input.field
      {
        height:30px;
        width:200px;
        line-height:30px;
        font-family:Lato, Verdana, Arial, sans-serif;
        font-size:15px;
        border:1px solid #888;
        transition:box-shadow .3s ease-in;
        outline:none;
      }

      input.field:focus
      {
        box-shadow:0px 0px 2px #888 inset;
      }

      button.field
      {
        background:#710000;
        font-family:Lato, Verdana, Arial, sans-serif;
        color:#FFF;
        font-size:12px;
        line-height:20px;
        text-transform:uppercase;
        cursor:hand;
        border:1px solid #000;
        transition:background .3s ease-in;
      }

      div#button_list
      {
        left:0;
        right:0;
        top:70px;
        bottom:0;
      }

      div.running#button_list
      {
        top:320px;
      }

      span.prompt
      {
        width:50px;
      }
      textarea.field {
        border:1px solid #888;
        width:100%;
        height:100px;
        font-family:monospace;
        outline:none;
        resize:none;
      }

      div.blockish#big_wrapper
      {
        top:0;
        bottom:0;
        right:0;
        left:0;
        overflow:auto;
      }

      div.console
      {
        top:0;
        bottom:0;
        right:0;
        left:0;
        position:absolute;
        padding:5px;
      }

      div.indented
      {
        padding-left:10px;
      }

      div.monospace
      {
        font-family:'Courier New';
        font-size:13px;
        white-space:pre;
      }
      button.delete {
      	position:absolute;
      	right:9px;
      	width:30px;
      	height:30px;
      }
      button.delete:hover {
      	background:#F00;
      }
      button.edit {
      	position:absolute;
      	right:48px;
      	width:30px;
      	height:30px;
      	background:#007100;
      }
      button.edit:hover {
      	background:#0F0;
      }
      button.run {
      	position:absolute;
      	right:87px;
      	width:30px;
      	height:30px;
      	background:#000071;
      }
      button.run:hover {
      	background:#00F;
      }
      div.adialogged {
      	height:300px;
      	background:#FFF;
      	overflow:auto;
      }
      div.bdialogged {
      	height:250px;
      	background:#FFF;
      	overflow:auto;
      }
      div.fillbuttonheader {
      	position:relative;
      	top:0px;
      	left:0px;
      	width:100%;
      	height:25px;
      	background:#EEE;
      }
      div.buttonheader {
      	font-size:20px;
      	font-family:'Lato';
      	position:relative
      	top:0px;
      	left:0px;
      	width:100%;
      	height:45px;
      	border-bottom:1px solid #888;
      	text-align:center;
      	background:#EEE;
      }
      div.filleditorheader {
      	position:relative;
      	top:0px;
      	left:0px;
      	width:100%;
      	height:25px;
      	background:#EEE;
      }
      div.editorheader {
      	font-size:20px;
      	font-family:'Lato';
      	position:relative;
      	top:0px;
      	left:0px;
      	width:100%;
      	height:45px;
      	border-bottom:1px solid #888;
      	text-align:center;
      	background:#EEE;
      }
      div.fillconsoleheader {
      	position:relative;
      	top:0px;
      	left:0px;
      	width:100%;
      	height:25px;
      	background:#EEE;
      }
      div.consoleheader {
      	font-size:20px;
      	font-family:'Lato';
      	position:relative;
      	top:0px;
      	left:0px;
      	width:100%;
      	height:45px;
      	border-bottom:1px solid #888;
      	text-align:center;
      	background:#EEE;
      }
      div#log {
      	position:absolute;
      	top:70px;
      	bottom:0;
      	width:100%;
      	overflow:auto;
      }
      div#editor_wrap {
      	top:0px;
      	bottom:50%;
      	width:100%;
      	background:#FFF;
      }
      div#editor {
      	z-index:0;
      	top:71px;
      	bottom:0px;
      	left:0px;
      	right:0px;
      }
      div#console {
      	border-top:1px solid #888;
      	top:50%;
      	bottom:0px;
      	width:100%;
      	background:#FFF;
      }
      button#clearconsole, button#cleareditor {
      	position:absolute;
      	top:-16px;
      	right:9px;
      	width:30px;
      	height:30px;
      	background:#710000;
      }
	  	button#newebutton {
      	position:absolute;
      	top:-16px;
      	right:48px;
      	width:30px;
      	height:30px;
      	background:#007100;
      }
      button#savebutton {
      	position:absolute;
      	top:-16px;
      	right:48px;
      	width:30px;
      	height:30px;
      	background:#007100;
      }
      button#cancelbutton {
      	position:absolute;
      	top:-16px;
      	right:9px;
      	width:30px;
      	height:30px;
      	background:#710000;
      }
      button#runbutton {
      	position:absolute;
      	top:-16px;
      	right:87px;
      	width:30px;
      	height:30px;
      	background:#000071;
      	transition:opacity .3s ease-in;
      }
      button#clearconsole:hover, button#cleareditor:hover, button#cancelbutton:hover {
      	background:#F00;
      }
	  	button#newebutton:hover, button#savebutton:hover {
				background:#0F0;
	  	}
	  	button#runbutton:hover {
	  		background:#00F;
	  	}
	  	div.shader {
	  		position:fixed;
	  		top:0px;
	  		left:0px;
	  		right:0px;
	  		bottom:0px;
	  		background:rgba(100, 100, 100, 0.7)
	  	}
	  	div.confirmation {
	  		font-size:20px;
	  		position:absolute;
	  		width:200px;
	  		height:200px;
	  		top:50%;
	  		left:50%;
	  		margin-top:-100px;
	  		margin-left:-100px;
	  		text-align:center;
	  		box-shadow:0px 0px 2px 2px #444;
	  		background:#FFF;
	  	}
	  	button#confirm {
	  		position:absolute;
	  		top:150px;
	  		left:20px;
	  		width:30px;
	  		height:30px;
	  		background:#007100;
	  	}
	  	button#confirm:hover {
	  		background:#0F0;
	  	}
	  	button#deny {
	  		position:absolute;
	  		top:150px;
	  		right:20px;
	  		width:30px;
	  		height:30px;
	  	}
	  	button#deny:hover {
	  		background:#F00;
	  	}
	  	span.confirmtext {
	  		position:relative;
	  		top:65px;
	  	}
    </style>
  </head>
  <body>
    <div class="blockish" id="big_wrapper">
      <div class="blockish" id="left_wrap">
        <div id="button_list">
        	<div id="root">
        		<div class="fillbuttonheader"></div>
          	<div class="buttonheader">Buttons</div>
          </div>
        </div>
      </div>
      <div class="blockish" id="right_wrap">
      	<div class="blockish" id="editor_wrap">
      		<div class="filleditorheader"></div>
      		<div class="editorheader">
						<span id="editortitle">Editor</span>
						<span class="init_hidden" id = "editor_new_name">Name: <input id="new_ebutton_name" class="field"/></span>
						<button id="savebutton" class="field init_hidden" title="Save">S</button>
						<button id="cancelbutton" class="field init_hidden" title="Cancel">C</button>
						<button id="runbutton" class="field" title="Run">R</button>
						<button id="newebutton" class="field" title="New button from editor">N</button>
						<button id="cleareditor" class="field" title="Clear">C</button>
					</div>
      		<div id="editor" class="blockish"></div>
      		<script src="src-noconflict/ace.js"></script>
					<script>
    				var editor = ace.edit("editor");
						editor.setTheme("ace/theme/github");
						editor.getSession().setMode("ace/mode/javascript");
						editor.getSession().setTabSize(2);
						editor.getSession().setUseWorker(false);
					</script>
      	</div>
      	<div class="blockish" id="console">
      		<div class="fillconsoleheader"></div>
      		<div class="consoleheader">
      			Console
      			<button id="clearconsole" class="field" title="Clear">C</button>
      		</div>
        	<div class="monospace" id="log"></div>
        </div>
      </div>
      <div class="shader init_hidden"></div>
      <div class="confirmation init_hidden">
      	<span class="confirmtext">Really?</span>
      	<button id="confirm" class="field" title="Yes">Y</button>
      	<button id="deny" class="field" title="No">N</button>
      </div>
    </div>
  </body>
</html>
