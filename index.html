<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>
      $(function()  {
        var buttons = [],
            root_expanded,
            root_button = $("div#root").click(function() {
              if (!root_expanded) {
                root_button.addClass("dialogged");
                setTimeout(function() {$("#root_dialog").show();}, 300);
                root_expanded = true;
              }
            }),
            button_list = $("div#button_list"),
            log = $("div#log"),
            create_button = $("button#create").click(function() {
              var new_button_obj, new_button, nindex = buttons.length;
              buttons.push(new_button_obj = {
                "name": nbname.val(),
                "commands": nbcmd.val()
              });
              root_button.after(new_button = $("<div>").addClass("button").attr("title", new_button_obj.commands).click(function() {
                interpretation = interpret(new_button_obj.commands);
                for (var i = 0; i < interpretation.length; i += 1) {
                  log_div = $("<div>").addClass("log").text("[" + new_button_obj.name + "] " + new_button_obj.commands.split('\n')[i]);
                  log.append(log_div);
                  log_div[0].scrollIntoView(false);
                  $.ajax({
                    url: "http://130.64.94.79:8080/execute?" + interpretation[i], /*error: function(blah, err, log_div) {
                      if (err == 'error') log_div.append($('<div>').addClass('indented').text("couldn't connect"));
                    }(log_div),*/
                    dataType: "json",
                    success: (function(log_div) {
                      return function(response) {
              	        log_div.append($('<div>').addClass('indented').text(response.success ? "Success" : "Failure"));
                      }
                    }(log_div))
                  });
                }
              }).append($('<button>').addClass('edit').addClass('field').addClass('greenfield').text('E').click(function() {
                $('#button_new_name').val(new_button.children().eq(2).text());
                $('#button_new_commands').val(new_button_obj.commands);
              	new_button.addClass('bdialogged');
              	setTimeout(function() {
              		new_button.children('.button_dialog').show();
              	}, 300);
              })).append($("<button>").addClass('delete').addClass('field').text('D').click(function() {
                new_button.remove();
                buttons.splice(nindex, 1);
              })).append($('<div>').text(new_button_obj.name)).append($('<div>').addClass('init_hidden').addClass('button_dialog').html('<div class="field_wrapper">Name: <input class="field" id="button_new_name"/></div><div class="field_wrapper"><div class="textarea_field_label">Commands:</div><textarea class="field" id="button_new_commands"></textarea></div>').append($('<button>').addClass('field').text('done').click(function() {
              	new_button.children().eq(2).text($('#button_new_name').val());
              	new_button_obj.name = $('#button_new_name').val();
              	new_button_obj.commands = $('#button_new_commands').val();
              	new_button.removeClass('bdialogged');
              	new_button.children('.button_dialog').hide();
              }))));
              root_button.removeClass("dialogged");
              $("#root_dialog").hide();
              nbname.val(""); nbcmd.val("");
              setTimeout(function() { root_expanded = false }, 0);
            }),
            cancel_button = $("button#cancel").click(function() {
              root_button.removeClass("dialogged");
              $("#root_dialog").hide();
              nbname.val(""); nbcmd.val("");
              setTimeout(function() { root_expanded = false }, 0);
            }),
            nbname = $("#new_button_name"),
            nbcmd = $("#new_button_commands");

        function interpret(commands) {
          var lines = commands.split("\n"),
              rarray = [];
          for (var i = 0; i < lines.length; i += 1) {
            var index, key, srarray = [];
            srarray.push("command=" + encodeURIComponent(lines[i].slice(0, index = lines[i].indexOf(" "))));
            if (index === -1) {
              rarray.push("command=" + encodeURIComponent(lines[i]));
            }
            else {
              params = lines[i].slice(index + 1).split(", ");
              for (var x = 0; x < params.length; x += 1) {
                key = params[x].slice(0, index = params[x].indexOf(" "));
                value = encodeURIComponent(params[x].slice(index + 1));
                srarray.push(key + "=" + value);
              }
              rarray.push(srarray.join("&"));
            }
          }
          return rarray;
        }
      })
    </script>
    <style>
      body, html {
        margin: 0px;
        padding: 0px;
        background: #EEE;
        overflow:hidden;
        font-family:'Lato', 'Verdana', 'Arial', sans-serif;
      }
      div.blockish {
        position:absolute;
      }
      div.blockish#left_wrap {
        left:0px;
        top:0px;
        bottom:0px;
        right:50%;
        overflow:auto;
      }
      div.blockish#right_wrap {
        left:50%;
        top:0px;
        bottom:0px;
        right:0px;
        border-left:1px solid #888;
        box-shadow: 1px 0px 1px #888 inset;
      }
      div#left_wrap {
        background: #FFF;
        font-family: monospace;
        overflow:auto;
      }
      div.button {
        height:50px;
        line-height:50px;
        cursor:pointer;
        padding:10px;
        font-size:20px;
        border-bottom: 1px solid #888;
        box-shadow: 1px 0px 1px #888 inset;
        transition: background 0.3s ease-in, height 0.3s ease-in, color 0.3s ease-in;
        color: #000;
      }
      div.button:nth-of-type(odd) {
        background: #EEE;
      }
      div.button:nth-of-type(even), div.button:nth-of-type(odd):hover {
        background: #DDD;
      }
      div.button:nth-of-type(even):hover {
      	background: #CCC;
      }
      div.button#root {
        background: #FFF;
      }
      div.button#root:hover {
        color: #710001;
      }
      div.button#root.dialogged {
        height:300px;
        cursor:auto;
        color: #000;
        overflow:auto;
      }
      .init_hidden {
        display:none;
      }
      input.field {
        height:30px;
        width:200px;
        line-height:30px;
        font-family:'Lato', 'Verdana', 'Arial', sans-serif;
        font-size: 15px;
        border: 1px solid #888;
        transition: box-shadow 0.3s ease-in;
        outline: none;
      }
      input.field:focus {
        box-shadow: 0 0 2px #888 inset;
      }
      button.field {
        background:#710000;
        font-family:'Lato', 'Verdana', 'Arial', sans-serif;
        color: #FFF;
        font-size: 12px;
        line-height: 20px;
        text-transform: uppercase;
        cursor:hand;
        border: 1px solid #000;
        transition: background 0.3s ease-in;
      }
      button.field:hover, button.field:focus {
        background:#F00;
      }
      button.greenfield {
      	background:#007100;
      }
      button.greenfield:hover {
      	background:#0F0;
      }
      div#button_list {
        left:0;
        right:0;
        top:70px;
        bottom:0px;
        transition: top 0.3s ease-in;
      }
      div.running#button_list {
        top:320px;
      }
      span.prompt {
        width:50px;
      }
      div#root_dialog {
        font-size:17px;
      }
      textarea.field {
        border: 1px solid #888;
        width: 100%;
        height: 100px;
        font-family: monospace;
        outline: none;
        resize: none;
      }
      div.blockish#big_wrapper {
        top:0;
        bottom:0;
        right:0;
        left:0;
        overflow:auto;
      }
      div.console {
      	top:0;
      	bottom:0;
      	right:0;
        left:0;
      	position:absolute;
        padding: 5px;
      }
      div.indented {
        padding-left:10px;
      }
      div.monospace {
      	font-family:monospace;
      	font-size:12px;
        white-space:pre;
      }
      button.delete {
      	position:absolute;
      	right:9px;
      	width:30px;
      	height:30px;
      }
      button.edit {
      	position:absolute;
      	right:48px;
      	width:30px;
      	height:30px;
      }
      div.bdialogged {
      	height:300px;
      	background:#FFF;
      	overflow:auto;
      }
      div.consoleheader {
      	font-size:20px;
      	font-family:'Lato';
      	position:fixed;
      	top:25px;
      	left:0px;
      	width:50%;
      	height:45px;
      	border-bottom:1px solid black;
      	text-align:center;
      }
      div#log {
      	position:absolute;
      	top:70px;
      	bottom:0;
      	width:100%;
      	overflow:auto;
      }
    </style>
  </head>
  <body>
    <div class="blockish" id="big_wrapper">
      <div class="blockish" id="left_wrap">
      	<div class="consoleheader">Console</div>
        <div class="monospace" id="log"></div>
      </div>
      <div class="blockish" id="right_wrap">
        <div id="button_list">
          <div class="button" id="root">
            + Create a Button
            <div class="init_hidden" id="root_dialog">
              <div class="field_wrapper">
                Name: <input class="field" id="new_button_name"/>
              </div>
              <div class="field_wrapper">
                <div class="textarea_field_label">Commands:</div>
                <textarea class="field" id="new_button_commands"></textarea>
              </div>
              <div class="field_wrapper">
                <button class="field" id="create">create</button>
                <button class="field" id="cancel">cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
